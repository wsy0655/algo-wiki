## ğŸ“Œ ä¸€ã€å‰ç¼€å’Œ

---

**ğŸ¯ æ ¸å¿ƒæ¦‚å¿µ**

**ä»€ä¹ˆæ˜¯å‰ç¼€å’Œï¼Ÿ**  
æ•°åˆ—å‰ $i$ é¡¹çš„å’Œï¼š

$$
pre_i \;=\; a_1 + a_2 + \cdots + a_i
$$

> **å®ƒèƒ½åšä»€ä¹ˆï¼Ÿ**  
> - å¿«é€Ÿè·å–åŒºé—´å’Œã€åŒºé—´å†…è´¨æ•°/å¥‡æ•°/å¶æ•°ä¸ªæ•°ç­‰  
> - å¯æ‹“å±•è‡³ï¼šå‰ç¼€ç§¯ã€å‰ç¼€å¼‚æˆ–ç­‰

---

### ğŸ” ä¸€ç»´å‰ç¼€å’Œ

**1ï¸âƒ£ å®šä¹‰**

- ä»¤  
  $$
   pre_i = \sum_{j=1}^i a_j \quad\Longrightarrow\quad pre_i = a_1 + a_2 + \cdots + a_i
 $$
- ä¾‹å¦‚ï¼š  
  - $pre_1 = a_1$ 
  - $pre_2 = a_1 + a_2$  
  - $\cdots$ 
  - $pre_n = a_1 + a_2 + \cdots + a_n$

- **é€’æ¨å…³ç³»**  
  $$
   pre_i = pre_{i-1} + a_i
 $$

```cpp
// C++ ç¤ºä¾‹ï¼šç»´æŠ¤ä¸€ç»´å‰ç¼€å’Œ
for (int i = 1; i <= n; i++) 
{
    cin >> a[i];
    pre[i] = pre[i - 1] + a[i];
}
```


> ğŸ’¡ æ³¨æ„æ•°æ®èŒƒå›´æ˜¯å¦éœ€è¦ `long long`ã€‚

---

**æ€§è´¨**

- **åŒºé—´å’ŒæŸ¥è¯¢**  
  æ±‚åŒºé—´ $i \sim j$ å†…çš„æ•°å­—ä¹‹å’Œï¼Œå¯ä»¥ä½¿ç”¨  
  $$
  pre_j - pre_{i-1}
  $$  
  **è¯æ˜ï¼š**  


$$
\begin{aligned}
pre_j &= a_1 + a_2 + \cdots + a_{i-1} + a_i + \cdots + a_j,\\
pre_{i-1} &= a_1 + a_2 + \cdots + a_{i-1},\\
\Rightarrow\, pre_j - pre_{i-1} &= a_i + \cdots + a_j
\end{aligned}
$$

---

**å¸¸è§åº”ç”¨**

- **ç»™å®š $l, r$**  
  ç›´æ¥ç”¨  
  $$
  pre_r - pre_{l-1}
  $$  
  æŸ¥è¯¢åŒºé—´å’Œã€‚

- **å·²çŸ¥èµ·ç‚¹ $l$ å’ŒåŒºé—´é•¿åº¦ $len$**  
  ç»ˆç‚¹ä¸º $r = l + len - 1$ã€‚ç„¶åç”¨  
  $$
  pre_r - pre_{l-1}
  $$  
  æŸ¥è¯¢åŒºé—´å’Œã€‚

- **æ³¨æ„**  
  å‰ç¼€å’Œä¸ä»…ä»…å±€é™äº **å’Œ**ã€‚å®ƒä¸»è¦æ˜¯é¢„å¤„ç†çš„ç®—æ³•ï¼Œé€šè¿‡ä¸€æ®µå‰ç¼€å‡å»å¦ä¸€æ®µå‰ç¼€ï¼Œå¾—åˆ°æŸä¸€æ®µåŒºé—´çš„ä¿¡æ¯ã€‚ä¾‹å¦‚ï¼š  
  - åŒºé—´å†…è´¨æ•°ä¸ªæ•°  
  - åŒºé—´å†…å¥‡æ•°/å¶æ•°ä¸ªæ•°/å«æœ‰ $3$ çš„æ•°å­—ä¸ªæ•°ç­‰  
  - åŒºé—´å¼‚æˆ–å€¼ç­‰

---

### ğŸ“š äºŒç»´å‰ç¼€å’Œ


**é¢„å¤„ç†ï¼šäºŒç»´å‰ç¼€å’Œ**

- **å®šä¹‰äºŒç»´å‰ç¼€å’Œæ•°ç»„**  
  ä»¤ $\displaystyle pre[i][j]$ è¡¨ç¤ºçŸ©é˜µ $a$ ä¸­å­çŸ©é˜µ $[1..\,i]\times [1..\,j]$ çš„å…ƒç´ ä¹‹å’Œï¼Œå³  
  $$
  pre[i][j]
  \;=\;
  \sum_{x=1}^{i} \sum_{y=1}^{j} a_{x,y},
  \quad 1 \le i \le n,\;1 \le j \le m.
  $$

![](https://cdn.luogu.com.cn/upload/image_hosting/7o1zb76m.png)

- **é€’æ¨å…¬å¼**  
  
$$
pre[i][j]=pre[i-1][j]+pre[i][j-1]-pre[i-1][j-1]
+
a_{i,j}
$$



![](https://cdn.luogu.com.cn/upload/image_hosting/9f62gfoq.png)

å³ **è“ + é»„ + ç»¿ + æ©™ = (è“ + é»„) + (è“ + ç»¿) - è“ + æ©™** æœ€ç»ˆæ±‚å¾—äº† $pre_{i, j}$
  


---

**æŸ¥è¯¢å…¬å¼ & æ—¶é—´å¤æ‚åº¦**

- **æŸ¥è¯¢å…¬å¼**  
  å¯¹äºä¸€æ¬¡æŸ¥è¯¢ $(x_1,y_1)$ åˆ° $(x_2,y_2)$ èŒƒå›´å†…çš„å­çŸ©é˜µå’Œï¼ŒæŒ‰ä¸‹å¼è®¡ç®—ï¼š  

$$\begin{aligned}
&\sum_{i=x_1}^{x_2} \sum_{j=y_1}^{y_2} a_{i,j}\\
=&pre[x_2][y_2]-pre[x_1-1][y_2]-pre[x_2][y_1-1]+pre[x_1-1][y_1-1].
\end{aligned}$$



![](https://cdn.luogu.com.cn/upload/image_hosting/qr1slsoh.png)


å› æ­¤å…¬å¼ 
$$
pre_{x_2,\ y_2}-pre_{x_1-1,\ y_2}-pre_{x_2,\ y_1-1}+pre_{x_1-1,\ y_1-1}
$$ 

å¯ä»¥æ¦‚æ‹¬ä¸º **ç»¿ + è“ + æ©™ + é»„ - (ç»¿ + è“) - (ç»¿ + æ©™) + ç»¿ = é»„**ã€‚

- **æ—¶é—´å¤æ‚åº¦**  
  - é¢„å¤„ç†ï¼šæ„é€  $pre[i][j]$ éœ€è¦ $O(n \times m)$ã€‚  
  - æŸ¥è¯¢ï¼šæ¯æ¬¡å¸¸æ•°æ¬¡è®¿é—® $pre$ï¼Œ$O(1)$ï¼Œå…± $Q$ æ¬¡æ•… $O(Q)$ã€‚

---



## âœï¸ äºŒã€å·®åˆ†

---

### ğŸ” ä¸€ç»´å·®åˆ†

**ğŸ¯ æ ¸å¿ƒæ¦‚å¿µ**

> **ä»€ä¹ˆæ˜¯å·®åˆ†ï¼Ÿ**  
> å·®åˆ†æ˜¯ä¸€ç§ä¸å‰ç¼€å’Œç›¸å¯¹çš„æŠ€å·§ï¼Œå¯è§†ä¸ºå‰ç¼€å’Œçš„é€†è¿ç®—ã€‚é€šè¿‡å·®åˆ†æ•°ç»„ï¼Œæˆ‘ä»¬å¯ä»¥é«˜æ•ˆåœ°å¤„ç†æŸäº›â€œåŒºé—´ä¿®æ”¹â€ç±»é—®é¢˜ã€‚  

- è®¾åŸæ•°ç»„ä¸º $a_1, a_2, \ldots, a_n$ï¼Œåˆ™å·®åˆ†æ•°ç»„ $b_1, b_2, \ldots, b_n$ å®šä¹‰ä¸ºï¼š
    
$$
\begin{cases}
  b_1 = a_1,\\
  b_i = a_i - a_{i-1}, \quad i = 2,3,\ldots,n.
\end{cases}
$$


- **ç¤ºä¾‹ï¼š**  
  - $b_1 = a_1$  
  - $b_2 = a_2 - a_1$ 
  - $b_3 = a_3 - a_2$ 
  - $\ldots$

---

**ğŸ”¹ æ€§è´¨ä¸€ï¼šå‰ç¼€è¿˜åŸåŸæ•°ç»„**

- **ç»“è®ºï¼š**  
  åŸæ•°ç»„ $a_i$ ç­‰äºå·®åˆ†æ•°ç»„ $b$ çš„å‰ç¼€å’Œï¼š  
  $$
  a_i = \sum_{j=1}^i b_j.
  $$
- **è¯æ˜ï¼š**  


$$
\begin{aligned}
a_n &= b_1 + b_2 + \cdots + b_n \\
    &= a_1 + (a_2 - a_1) + (a_3 - a_2) + \cdots + (a_n - a_{n-1}) \\
    &= a_n.
\end{aligned}
$$



> ä¾‹å¦‚ï¼š  
>
> $$
> \begin{aligned}
>   a_1 &= b_1,\\
>   a_2 &= b_1 + b_2 = a_1 + (a_2 - a_1),\\
>   a_3 &= b_1 + b_2 + b_3 = a_1 + (a_2 - a_1) + (a_3 - a_2).
> \end{aligned}
> $$

---

**ğŸ”¹ æ€§è´¨äºŒï¼šåŒºé—´åŠ æ³•ä¼˜åŒ–ï¼ˆæ ¸å¿ƒåº”ç”¨ï¼‰**

- **ç›®æ ‡ï¼š**  
  å°†åŸæ•°ç»„ä¸­åŒºé—´ $[l, r]$ å†…çš„æ‰€æœ‰å…ƒç´ å¢åŠ å¸¸æ•° $c$ã€‚  

- **å·®åˆ†åšæ³•ï¼š**  
  åªéœ€åœ¨å·®åˆ†æ•°ç»„ä¸Šæ‰§è¡Œä¸¤æ­¥ï¼Œæ—¶é—´ $O(1)$ï¼š  

$$
\begin{cases}
  b_l \;+=\; c,\\
  b_{r+1} \;-\!=\; c.
\end{cases}
$$  

  è¿™æ ·ï¼Œæ¢å¤åŸæ•°ç»„æ—¶ï¼Œ$$a_l,\dots,a_r$$ å…¨éƒ¨å¢åŠ  $c$ï¼Œå…¶å®ƒä½ç½®ä¸å˜ã€‚

---

**å…·ä½“è¯æ˜**

1. ä¿®æ”¹ $b_l += c$ åï¼š  
      - å¯¹äº $i < l$ï¼Œ$b_1,\dots,b_{l-1}$ éƒ½ä¸å˜ï¼Œæ•… $a_1,\dots,a_{l-1}$ ä¸å˜ã€‚  
      - å¯¹äº $i \ge l$ï¼Œ$b_l$ å˜ä¸º $b_l + c$ï¼Œæ¢å¤æ—¶ä» $a_l$ å¼€å§‹åˆ°æœ«å°¾éƒ½å¤šåŠ  $c$ã€‚  

2. å†æ‰§è¡Œ $b_{r+1} -= c$ï¼š  
      - å¯¹äº $i \le r$ï¼Œå·²ç»æ¯é¡¹å¤šåŠ  $c$ï¼Œæ•… $a_l,\dots,a_r$ æ­£ç¡®åŠ  $c$ã€‚  
      - å¯¹äº $i \ge r+1$ï¼Œåœ¨åŸæœ¬å·²åŠ  $c$ çš„åŸºç¡€ä¸Šå†å‡ $c$ï¼Œæ¢å¤åˆ°åŸå€¼ã€‚  

å› æ­¤ï¼Œåªæ”¹ $b_l$ å’Œ $b_{r+1}$ å³å¯å®ŒæˆåŒºé—´åŠ æ“ä½œã€‚

---

**ğŸ”¹ å·®åˆ†æ•°ç»„æ¨¡æ¿**

- **é¢„å¤„ç†å·®åˆ†æ•°ç»„**ï¼ˆè‹¥åˆå§‹ $a$ ä¸å…¨ $0$ï¼‰ï¼š  
   ```cpp
   for (int i = 1; i <= n; i++) 
   {
       cin >> a[i];
       b[i] = a[i] - a[i - 1]; // å·®åˆ†å®šä¹‰
   }
   ```
   > è‹¥åŸæ•°ç»„å…¨ä¸º $0$ï¼Œåˆ™å¯è·³è¿‡é¢„å¤„ç†ï¼Œç›´æ¥æ“ä½œ `b` æ•°ç»„ã€‚

---


- **åŒºé—´ä¿®æ”¹æ“ä½œï¼ˆå°† `[x, y]` èŒƒå›´å†…å…ƒç´ åŠ  `z`ï¼‰**ï¼š
```cpp
while (m--) 
{
    int x, y, z;
    cin >> x >> y >> z;
    b[x]     += z;
    b[y + 1] -= z;
}
```

- **è¿˜åŸåŸæ•°ç»„å¹¶æ±‚å€¼**

- æ–¹æ³•ä¸€ï¼šé€šè¿‡å‰ç¼€å’Œè¿˜åŸ $a$ï¼Œé¡ºä¾¿æ±‚æœ€å°/æœ€å¤§ç­‰ï¼š
  ```cpp
  int ans = 1e9;
  for (int i = 1; i <= n; i++) 
  {
      b[i] += b[i - 1]; // å‰ç¼€å’Œè¿˜åŸ a[i]
      ans = min(ans, b[i]);
  }
  ```
- æ–¹æ³•äºŒï¼šå…ˆæ¢å¤ `a[i] = a[i - 1] + b[i]`ï¼Œåœ¨åšå…¶ä»–è¿ç®—ï¼š
  ```cpp
  int ans = 1e9;
  for (int i = 1; i <= n; i++) 
  {
      a[i] = a[i - 1] + b[i]; // å‰ç¼€å’Œè¿˜åŸ a[i]
      ans = min(ans, a[i]);
  }
  ```

**å¦ä¸€ç§å†™æ³•ï¼šä¸éœ€è¦é¢„å¤„ç†å·®åˆ†æ•°ç»„**

ç›´æ¥ç»´æŠ¤å·®åˆ†æ•°ç»„ `b`ï¼Œæœ€åæ±‚ `b` çš„å‰ç¼€å’Œå¾—åˆ°æ¯ä¸ª `a[i]` çš„å¢é‡ï¼Œç„¶åç´¯åŠ åˆå§‹å€¼ `a[i]` å³å¯ã€‚


```cpp
#include <bits/stdc++.h>
using namespace std;
constexpr int N = 2e5 + 5;
int n, a[N], b[N], q;
int main()
{
    cin >> n >> q;
    for (int i = 1; i <= n; i++)
        cin >> a[i];
    while (q--)
    {
        int x, y, z;
        cin >> x >> y >> z;
        b[x] += z;
        b[y + 1] -= z;
    }
    for (int i = 1; i <= n; i++)
    {
        b[i] += b[i - 1];
        a[i] += b[i];
        cout << a[i] << " ";
    }
    return 0;
}
```


---

### ğŸ”¸ äºŒç»´å·®åˆ†


äºŒç»´å·®åˆ†å…¶å®æ˜¯äºŒç»´å‰ç¼€å’Œçš„åæ“ä½œï¼Œå…¶å…³ç³»ä¸º

$$
b_{i,j} = a_{i,j} - a_{i-1,j} - a_{i,j-1} + a_{i-1,j-1}.
$$


ç±»ä¼¼ä¸€ç»´å·®åˆ†ä¸­å¯¹åŒºé—´è¿›è¡Œç»Ÿä¸€åŠ æ³•ï¼Œæ‰§è¡ŒæŒ‡ä»¤

$$
b_{i,j} \mathrel{+}= k
$$

åï¼Œå°†ä½¿ä»¥ $(i,j)$ ä¸ºå·¦ä¸Šè§’ã€$(n,m)$ ä¸ºå³ä¸‹è§’çš„æ‰€æœ‰ä½ç½®éƒ½å¢åŠ  $k$ã€‚ 


**å­çŸ©é˜µçš„ä¿®æ”¹ï¼š**

å¯æŒ‰å¦‚ä¸‹è°ƒæ•´äºŒç»´å·®åˆ†æ•°ç»„ï¼š

- $b_{x_1,y_1} \mathrel{+}= c$
    - åœ¨ä½ç½® $(x_1,y_1)$ å¤„ $+c$ï¼Œæ ¹æ®å‰ç¼€å’Œçš„æ€§è´¨ï¼Œé‚£ä¹ˆå®ƒå½±å“çš„æ˜¯ **é»„ + è“ + æ©™ + ç»¿**ï¼Œå¤šå½±å“äº† **è“ + æ©™ + ç»¿**ï¼Œå› æ­¤éœ€è¦æ¶ˆé™¤é¢å¤–çš„å½±å“ã€‚
- $b_{x_1,y_2+1} \mathrel{-}= c$
    - $b_{x_1,y_2+1}-c$ï¼Œä¼šé€ æˆå›¾ä¸­ **ç»¿ + è“** è¿™ä¸¤éƒ¨åˆ†éƒ½å‡ $c$
- $b_{x_2+1,y_1} \mathrel{-}= c$
    - $b_{x_2+1,y_1}-c$ï¼Œä¼šé€ æˆå›¾ä¸­ **ç»¿ + æ©™** è¿™ä¸¤éƒ¨åˆ†éƒ½å‡ $c$
- $b_{x_2+1,y_2+1} \mathrel{+}= c$
    - $b_{x_2+1,y_2+1}+c$ï¼Œä¼šé€ æˆå›¾ä¸­ **ç»¿** è¿™éƒ¨åˆ†åŠ  $c$

![](https://cdn.luogu.com.cn/upload/image_hosting/yosx7j35.png)






### âœ¨ ç­‰å·®æ•°åˆ—å·®åˆ†

---

**ğŸ¯ å‰ç½®çŸ¥è¯†ï¼šç­‰å·®æ•°åˆ—**

- **å®šä¹‰**ï¼šè‹¥ä¸€ä¸ªæ•°åˆ—ä»ç¬¬äºŒé¡¹èµ·ï¼Œæ¯é¡¹ä¸å‰ä¸€é¡¹çš„å·®éƒ½ç›¸åŒï¼Œåˆ™ç§°ä¸ºç­‰å·®æ•°åˆ—ã€‚è¯¥å·®å€¼ç§°ä¸ºâ€œå…¬å·®â€ $d$ã€‚  
- **è®°æ³•**ï¼šé¦–é¡¹ $a_1$ã€æœ«é¡¹ $a_n$ã€å…¬å·® $d$ã€‚  

**åŸºæœ¬å…¬å¼**ï¼š  
- ç­‰å·®æ•°åˆ—å‰ $n$ é¡¹å’Œï¼š  
  $$
  S_n = \frac{(a_1 + a_n)\times n}{2}.
  $$
- è‹¥å·²çŸ¥ $a_l$ ä¸ $a_r$ï¼Œåˆ™å…¬å·®ï¼š  
  $$
  d = \frac{a_r - a_l}{r - l}.
  $$

---

**ğŸ”¹ é¢˜æ„**

- ç»™å®š $m$ æ¬¡æ“ä½œï¼Œæ¯æ¬¡é€‰æ‹©åŒºé—´ $[l, r]$ï¼Œä½¿è¯¥åŒºé—´å†…æ‰€æœ‰æ•°å­—åŠ ä¸Šä¸€ä¸ªç­‰å·®æ•°åˆ—ï¼Œé¦–é¡¹ä¸º $s$ã€æœ«é¡¹ä¸º $e$ã€‚  
- ç”±æ­¤å¯ç®—å‡ºå…¬å·®ï¼š  
  $$
  d = \frac{e - s}{r - l}.
  $$

---

**ğŸ”¹ äºŒæ¬¡å·®åˆ†å¼•å…¥**

1. **ä¸€æ¬¡å·®åˆ†**ï¼š  
   $$
   b_i = a_i - a_{i-1}.
   $$
2. **äºŒæ¬¡å·®åˆ†**ï¼š  
   $$
   c_i = b_i - b_{i-1}.
   $$
3. å½“å¯¹åŒºé—´ $[l, r]$ å¢åŠ ç­‰å·®æ•°åˆ—æ—¶ï¼Œåªæœ‰å°‘æ•°å‡ ä¸ªä½ç½®çš„ $b$ å’Œ $c$ ä¼šå‘ç”Ÿå˜åŒ–ï¼Œå…·ä½“å¦‚ä¸‹ï¼š

---

**ğŸ”¸ äºŒæ¬¡å·®åˆ†ç¤ºæ„**

å‡è®¾åœ¨ $[l, r]$ åŒºé—´åŠ ç­‰å·®æ•°åˆ—ï¼Œé¦–é¡¹ $s$ã€æœ«é¡¹ $e$ã€å…¬å·® $d$ã€‚åˆ™ï¼š


|        ä¸‹æ ‡         | $l - 1$ |        $l$        |       $l + 1$        | $\cdots$ |       $r$        |         $r + 1$         |     $r + 2$      |
| :-----------------: | :-----: | :---------------: | :------------------: | :------: | :--------------: | :---------------------: | :--------------: |
| **åŸæ•°ç»„ $a$ å¢é‡** |    0    | $\color{red}{ s}$ | $\color{red}{s + d}$ | $\cdots$ | $\color{red}{e}$ |            0            |        0         |
|  **ä¸€æ¬¡å·®åˆ† $b$**   |    0    | $\color{red}{s }$ |   $\color{red}{d}$   | $\cdots$ | $\color{red}{d}$ |    $\color{red}{-e}$    |        0         |
|  **äºŒæ¬¡å·®åˆ† $c$**   |    0    | $\color{red}{s}$  | $\color{red}{d - s}$ |    0     |        0         | $\color{red}{-(e + d)}$ | $\color{red}{e}$ |

> **åªéœ€ç»´æŠ¤** $c_l, c_{l+1}, c_{r+1}, c_{r+2}$ å››ä¸ªä½ç½®ï¼Œæ¢å¤æ—¶åšä¸¤æ¬¡å‰ç¼€å’Œå³å¯å¾—åˆ°åŸæ•°ç»„ $a$ã€‚



---

**ğŸ”¹ å®Œæ•´ä»£ç ï¼ˆ1D ç­‰å·®æ›´æ–° + äºŒæ¬¡å·®åˆ†ï¼‰**

```cpp
// è¯»å…¥ n, m çœç•¥
// c[] ä¸ºäºŒæ¬¡å·®åˆ†æ•°ç»„ï¼Œb[] ä¸ºä¸€æ¬¡å·®åˆ†æ•°ç»„ï¼Œa[] ä¸ºåŸæ•°ç»„
while (m--) 
{
    int l, r, s, e;
    cin >> l >> r >> s >> e;
    long long d = (e - s) / (r - l); // è®¡ç®—å…¬å·®
    c[l]     += s;
    c[l + 1] += d - s;
    c[r + 1] += -(e + d);
    c[r + 2] += e;
}
// æ¢å¤ï¼šå…ˆé€šè¿‡ä¸€æ¬¡ç´¯åŠ è¿˜åŸ bï¼Œå†é€šè¿‡ä¸€æ¬¡ç´¯åŠ è¿˜åŸ a
for (int i = 1; i <= n; i++) 
{
    b[i] = b[i - 1] + c[i];    // ä¸€æ¬¡å‰ç¼€å’Œè¿˜åŸåˆ° b
    a[i] = a[i - 1] + b[i];    // äºŒæ¬¡å‰ç¼€å’Œè¿˜åŸåˆ° a
}
```

â± æ—¶é—´å¤æ‚åº¦ï¼š$O(n+m)$ã€‚


## ğŸ“Œ ä¸‰ã€ç¦»æ•£åŒ–

---

**ğŸ¯ æ ¸å¿ƒæ¦‚å¿µ**

> **ä»€ä¹ˆæ˜¯ç¦»æ•£åŒ–ï¼Ÿ**  
> å°†åŸæ¥å€¼åŸŸå¾ˆå¤§çš„æ•°æ®ï¼Œ**æ˜ å°„åˆ°ä¸€ä¸ªè¿ç»­å°èŒƒå›´å†…**ï¼Œä¾¿äºå¼€æ•°ç»„ã€ä½¿ç”¨æ ‘çŠ¶æ•°ç»„ã€çº¿æ®µæ ‘ç­‰ã€‚

- ä½œç”¨ï¼šå°†ç¨€ç–çš„ä¸‹æ ‡å‹ç¼©æˆå¯†é›†çš„å°æ•´æ•°åŒºé—´ã€‚

---

**ğŸ”¹ ç¦»æ•£åŒ–æ­¥éª¤**

1. **æ”¶é›†æ‰€æœ‰å¾…ç¦»æ•£åŒ–çš„åæ ‡**  
   - å°†æ¯ä¸ªæ“ä½œæˆ–æŸ¥è¯¢ä¸­å‡ºç°çš„åæ ‡å€¼ï¼ˆå¦‚åŒºé—´ç«¯ç‚¹ã€æŸ¥è¯¢ç‚¹ï¼‰éƒ½åŠ å…¥ä¸€ä¸ªæ•°ç»„ `lsh` ä¸­ã€‚

2. **æ’åºå¹¶å»é‡**  
   ```cpp
   sort(lsh + 1, lsh + n + 1);
   int m = unique(lsh + 1, lsh + n + 1) - lsh - 1;

   sort(lsh.begin(), lsh.end());
   lsh.erase(unique(lsh.begin(), lsh.end()), lsh.end());
   ```
3. **äºŒåˆ†æŸ¥æ‰¾æ˜ å°„**  
   å¯¹äºä»»æ„åŸåæ ‡ `x`ï¼Œä½¿ç”¨  
    ```cpp
    int rank = lower_bound(lsh + 1, lsh + m + 1, a[i]) - lsh;

    int rank = lower_bound(lsh.begin(), lsh.end(), x) - lsh.begin() + 1;
    ```




## â­ï¸ å››ã€å’Œå¼å…¥é—¨ä¸æŠ€å·§

---

**ğŸ¯ æ ¸å¿ƒæ¦‚å¿µ**



**ä»€ä¹ˆæ˜¯å’Œå¼ï¼Ÿ**  

ç”¨ âˆ‘ è¡¨ç¤ºâ€œè¿ç»­ç›¸åŠ â€çš„è¡¨è¾¾å¼ï¼Œä¾‹å¦‚ï¼š  

$$
\sum_{i=1}^n i = 1 + 2 + 3 + \dots + n
$$  

åµŒå¥—ç¤ºä¾‹ï¼š  

$$
\sum_{i=1}^n \sum_{j=1}^m a_{i,j}
$$

- åœ¨ç®—æ³•ç«èµ›ä¸­ï¼Œå’Œå¼å¸¸ç”¨æ¥è¡¨ç¤ºå¾ªç¯ç´¯åŠ è¿‡ç¨‹ï¼Œç®€åŒ–ç‰ˆå³åŒ–ä¸ºå…¬å¼è®¡ç®—ã€‚

---

**ğŸ”¹ åŸºæœ¬æ€§è´¨**

1. **å¯æ‹†åˆ†ï¼ˆåŒºé—´æ‹†åˆ†ï¼‰**  
   
$$
\begin{aligned}
&\sum_{i=1}^{n} a_i \\
=&\sum_{i=1}^{m} a_i+\sum_{i=m+1}^{n} a_i.
\end{aligned}
$$

2. **å¯åˆ†é…ï¼ˆåŠ æ³•ï¼‰**  

$$
\begin{aligned}
&\sum_{i=1}^{n} (a_i + b_i) 
=&\sum_{i=1}^{n} a_i +\sum_{i=1}^{n} b_i.
\end{aligned}
$$

3. **å¸¸æ•°å¯æå–**  
  
$$
\sum_{i=1}^{n} k \,a_i =k \sum_{i=1}^{n} a_i.
$$

---

**ğŸ”¹ ä¾‹é¢˜ä¸åŒ–ç®€æŠ€å·§**

**ä¾‹é¢˜ 1 ï¼šæ¯ä¸ªæ•°è¢«åŠ äº†å‡ æ¬¡ï¼Ÿ**

- è®¾ $a_1, a_2, \dots, a_n$ æ˜¯ä¸€ä¸ªæ•°ç»„ã€‚åŒ–ç®€  

$$
\sum_{i=1}^n \sum_{j=i}^n a_i.
$$

- **è§‚å¯Ÿ**ï¼šå†…å±‚å’Œä¸ $j$ ç›¸å…³ï¼Œä½† $a_i$ ä¸ä¾èµ– $j$ï¼Œå¯æå–ï¼š  

$$
\begin{aligned}
&\sum_{i=1}^n a_i \sum_{j=i}^n 1 \\
= &\sum_{i=1}^n a_i \cdot (n - i + 1).
\end{aligned}
$$

å¤æ‚åº¦ä» $O(n^2)$ é™ä¸º $O(n)$ã€‚

---

**ä¾‹é¢˜ 2 ï¼šåµŒå¥—æ±‚å’Œ**

- åŒ–ç®€  
  
$$
\sum_{i=1}^n \sum_{j=i}^n (a_i \times j).
$$

- æå– $a_i$ï¼š  

$$
\begin{aligned}
&\sum_{i=1}^n a_i \sum_{j=i}^n j\\
=&\sum_{i=1}^n a_i \times \frac{(i + n)(n - i + 1)}{2}.
\end{aligned}
$$

---

**ğŸ”¹ äº¤æ¢æ±‚å’Œæ¬¡åºï¼ˆé‡è¦æŠ€å·§ï¼‰**

- äº¤æ¢å‰ï¼š  

$$
\sum_{i=1}^{n} \sum_{j=i}^{n} f(i, j).
$$

- äº¤æ¢é¡ºåºï¼š  

$$
= \sum_{j=1}^{n} \sum_{i=1}^{j} f(i, j).
$$

> â˜… æœ‰æ—¶äº¤æ¢é¡ºåºåæ›´æ˜“åŒ–ç®€ã€‚

---

**ä¾‹é¢˜ 3 ï¼šæ¢åºç®€åŒ–**

- $\displaystyle \sum_{i=1}^n \sum_{j=1}^i j$  
- **äº¤æ¢å‰å«ä¹‰**ï¼š  
  $(1) + (1 + 2) + (1 + 2 + 3) + \cdots + (1 + 2 + \cdots + n)$.  
- **äº¤æ¢å**ï¼š  

$$
\sum_{j=1}^n \sum_{i=j}^n j = \sum_{j=1}^n j \cdot (n - j + 1).
$$

---

**ä¾‹é¢˜ 4 ï¼šåŒé‡å’Œå¼**

$$\begin{aligned}
        &\sum\limits_{i=1}^n \sum\limits_{j=i}^n a_i\times a_j\\ 
        =&\sum\limits_{j=1}^n \sum\limits_{i=1}^j a_i\times a_j\\
        =&\sum\limits_{j=1}^n a_j \sum\limits_{i=1}^j a_i\\
        =&\sum\limits_{j=1}^n a_j\times pre[j]
    \end{aligned}$$



### ä¾‹é¢˜ï¼š[CSP-S2019 æ±Ÿè¥¿] å’Œç§¯å’Œ

**é¢˜ç›®ç›®æ ‡ï¼š**


$$
\text{è®¡ç®— }\  ans = \sum_{l=1}^n \sum_{r=l}^n \left( \sum_{i=l}^r a_i \times \sum_{j=l}^r b_j \right)
$$

æ•°æ®èŒƒå›´ï¼š$n\leq 5\times 10^5$ã€‚


**è§£é¢˜æ€è·¯ï¼š**


å®šä¹‰å‰ç¼€å’Œï¼š

- $sa_x = \sum\limits_{i=1}^x a_i,\quad sb_x = \sum\limits_{i=1}^x b_i$

åŸå¼å˜ä¸ºï¼š

$$
ans = \sum_{l=1}^n \sum_{r=l}^n \left( (sa_r - sa_{l-1}) \times (sb_r - sb_{l-1}) \right)
$$


å±•å¼€ä¹˜ç§¯éƒ¨åˆ†ï¼Œå¾—åˆ°ï¼š


$$
sa_r\cdot sb_r - sa_r\cdot sb_{l-1} - sa_{l-1}\cdot sb_r + sa_{l-1}\cdot sb_{l-1}
$$

å³ï¼š

$$\begin{aligned}
ans &= \sum_{l=1}^n \sum_{r=l}^n \left( sa_r\cdot sb_r - sa_r\cdot sb_{l-1} - sa_{l-1}\cdot sb_r + sa_{l-1}\cdot sb_{l-1} \right)\\
&=\sum_{l=1}^n \sum_{r=l}^n sa_r\cdot sb_r-\sum_{l=1}^n \sum_{r=l}^n sa_r\cdot sb_{l-1} - \sum_{l=1}^n \sum_{r=l}^n sa_{l-1}\cdot sb_r+\sum_{l=1}^n \sum_{r=l}^n sa_{l-1}\cdot sb_{l-1}
\end{aligned}$$

æ¥ä¸‹æ¥å°†å¯¹å››ä¸ªéƒ¨åˆ†åˆ†åˆ«æ±‚å’Œã€‚

- **ç¬¬ä¸€éƒ¨åˆ†ï¼š$\sum\limits_{l=1}^n \sum\limits_{r=l}^n sa_r\cdot sb_r$**

å®šä¹‰ï¼š$SAB_x = \sum\limits_{i=1}^x sa_i \cdot sb_i$

æ•´é¡¹å’Œä¸ºï¼š$\sum\limits_{l=1}^n (SAB_n - SAB_{l-1})$

å¯é¢„å¤„ç†å $O(n)$ è®¡ç®—ã€‚

- **ç¬¬äºŒéƒ¨åˆ†ï¼š$\sum\limits_{l=1}^n \sum\limits_{r=l}^n sa_r \cdot sb_{l-1}$**

æå‡ºå¸¸æ•°ï¼š$= \sum\limits_{l=1}^n sb_{l-1} \cdot \sum\limits_{r=l}^n sa_r$


å®šä¹‰å‰ç¼€å’Œï¼š$SA_x = \sum\limits_{i=1}^x sa_i$

åˆ™ï¼š$= \sum\limits_{l=1}^n sb_{l-1} \cdot (SA_n - SA_{l-1})$


å¯é¢„å¤„ç†å $O(n)$ è®¡ç®—ã€‚


- **ç¬¬ä¸‰éƒ¨åˆ†ï¼š$\sum\limits_{l=1}^n \sum\limits_{r=l}^n sa_{l-1} \cdot sb_r$**


æå‡ºå¸¸æ•°ï¼š$= \sum\limits_{l=1}^n sa_{l-1} \cdot \sum\limits_{r=l}^n sb_r$

å®šä¹‰ï¼š$SB_x = \sum\limits_{i=1}^x sb_i$

åŒç†ï¼š$= \sum\limits_{l=1}^n sa_{l-1} \cdot (SB_n - SB_{l-1})$


å¯ $O(n)$ æ±‚è§£ã€‚



- **ç¬¬å››éƒ¨åˆ†ï¼š$\sum\limits_{l=1}^n \sum\limits_{r=l}^n sa_{l-1} \cdot sb_{l-1}$**

å°†å¸¸æ•°é¡¹æå‡ºï¼š$=\sum\limits_{l=1}^n sa_{l-1} \cdot sb_{l-1} \cdot \sum\limits_{r=l}^n 1 =\sum\limits_{l=1}^n sa_{l-1} \cdot sb_{l-1} \cdot (n - l + 1)$

ç›´æ¥æšä¸¾è®¡ç®—ï¼Œæ€»å¤æ‚åº¦ä»ä¸º $O(n)$ã€‚


- æœ€ç»ˆï¼š

$$\begin{aligned}
ans &= \sum_{l=1}^n SAB_n - SAB_{l-1} \\
&\quad - \sum_{l=1}^n sb_{l-1} \cdot (SA_n - SA_{l-1}) \\
&\quad - \sum_{l=1}^n sa_{l-1} \cdot (SB_n - SB_{l-1}) \\
&\quad + \sum_{l=1}^n sa_{l-1} \cdot sb_{l-1} \cdot (n - l + 1)
\end{aligned}$$


```cpp
#include <bits/stdc++.h>
using namespace std;
using ll = long long;
constexpr int N = 5e5 + 5, P = 1e9 + 7;
int n, a[N], b[N];
ll sa[N], sb[N];
ll SAB[N], SA[N], SB[N];
int main()
{
    ios::sync_with_stdio(false), cin.tie(0);
    cin >> n;
    for (int i = 1; i <= n; i++)
        cin >> a[i];
    for (int i = 1; i <= n; i++)
        cin >> b[i];
    for (int i = 1; i <= n; i++)
        sa[i] = (sa[i - 1] + a[i]) % P;
    for (int i = 1; i <= n; i++)
        sb[i] = (sb[i - 1] + b[i]) % P;
    for (int i = 1; i <= n; i++)
        SAB[i] = (SAB[i - 1] + sa[i] * sb[i]) % P;
    for (int i = 1; i <= n; i++)
        SA[i] = (SA[i - 1] + sa[i]) % P;
    for (int i = 1; i <= n; i++)
        SB[i] = (SB[i - 1] + sb[i]) % P;
    ll ans = 0;
    for (int i = 1; i <= n; i++)
    {
        ll sum1 = SAB[n] - SAB[i - 1];
        ll sum2 = sb[i - 1] * (SA[n] - SA[i - 1]) % P;
        ll sum3 = sa[i - 1] * (SB[n] - SB[i - 1]) % P;
        ll sum4 = sa[i - 1] * sb[i - 1] % P * (n - i + 1) % P;
        ans += sum1 - sum2 - sum3 + sum4;
        ans = (ans % P + P) % P;
    }
    cout << ans;
    return 0;
}
```

___

## å…¶ä½™ä¾‹é¢˜


### ä¾‹é¢˜ä¸€ï¼šåŒºé—´è´¨æ•°


å¯¹åŒºé—´ $[1,\,10^6]$ è¿›è¡ŒåŸƒæ°ç­›æ³•ï¼Œå¾—åˆ°å¸ƒå°”æ•°ç»„

$$
\text{is_prime}[i] =
\begin{cases}
  \text{true}, & i \text{ æ˜¯è´¨æ•°},\\
  \text{false}, & i \text{ æ˜¯åˆæ•°}.
\end{cases}
$$

å‰ç¼€å’Œåˆå§‹åŒ–ï¼š $pre[0]=0$ï¼Œå¯¹ $1\le i\le10^6$ï¼Œé€’æ¨ï¼š

$$
pre[i] = pre[i-1] + (\text{is_prime}[i]\,?\,1:\,0)
$$

å…¶ä¸­ $pre[i]$ è¡¨ç¤ºåŒºé—´ $[1,i]$ å†…è´¨æ•°ä¸ªæ•°ã€‚

åˆ™åŒºé—´è´¨æ•°ä¸ªæ•°ä¸ºï¼š$\text{ans} = pre[r] - pre[l-1]$

___

### ä¾‹é¢˜äºŒï¼šabc å­åºåˆ—é—®é¢˜


**é¢˜æ„ï¼š** ç»™å®šä¸€ä¸ªé•¿åº¦ä¸º $n,n\leq 5\cdot 10^5$ çš„å­—ç¬¦ä¸² $s$ï¼Œä½ å¯ä»¥å°†å…¶ä¸­ä»»æ„ä¸€ä¸ªå­—ç¬¦ä¿®æ”¹ä¸ºå¦ä¸€ä¸ªå°å†™å­—æ¯ï¼Œæœ€å¤šä¿®æ”¹ä¸€æ¬¡ã€‚é—®ï¼šé€šè¿‡æœ€å¤šä¸€æ¬¡æ“ä½œï¼Œå­—ç¬¦ä¸²ä¸­å­åºåˆ— $\text{abc}$ çš„æ•°é‡æœ€å¤šèƒ½è¾¾åˆ°å¤šå°‘ï¼Ÿ


è‹¥ä¸è¿›è¡Œä»»ä½•æ“ä½œï¼Œç­”æ¡ˆä¸ºåŸå­—ç¬¦ä¸²ä¸­å­åºåˆ— $\text{abc}$ çš„ä¸ªæ•°ã€‚

- æ¯ä¸€ä¸ªå­—ç¬¦ $\text{b}$ éƒ½å¯èƒ½ä½œä¸ºå­åºåˆ— $\text{abc}$ çš„ä¸­é—´å­—ç¬¦ã€‚æˆ‘ä»¬ç»Ÿè®¡æ¯ä¸ª $\text{b}$ å·¦ä¾§çš„ $\text{a}$ çš„æ•°é‡ä¸å³ä¾§çš„ $\text{c}$ çš„æ•°é‡ï¼Œå¹¶ç´¯åŠ ä¹˜ç§¯ã€‚

$$
\text{ans} = \sum_{j=1}^n [s_j = \texttt{'b'}] \cdot 
\left( \sum_{i=1}^{j} [s_i = \texttt{'a'}] \right) \cdot 
\left( \sum_{i=j}^{n} [s_i = \texttt{'c'}] \right)
$$

ä½¿ç”¨å‰ç¼€å’Œä¸åç¼€å’Œé¢„å¤„ç† $\text{a}$ ä¸ $\text{c}$ çš„å‡ºç°æ¬¡æ•°ï¼Œä½¿å¾—æ•´ä½“æ—¶é—´å¤æ‚åº¦ä¸º $O(n)$ã€‚


**ä¿®æ”¹ä¸€ä¸ªå­—ç¬¦åçš„æœ€å¤§åŒ–ç­–ç•¥**

ç”±äºåªèƒ½ä¿®æ”¹ä¸€ä¸ªå­—ç¬¦ $s_i$ï¼Œæˆ‘ä»¬å¯ä»¥æšä¸¾æ¯ä¸ªä½ç½® $i$ è¿›è¡Œå°è¯•ï¼Œæœ€ç»ˆç­”æ¡ˆä¸ºï¼š

$$
\text{æœ€å¤§å€¼} = \text{åŸå§‹ç­”æ¡ˆ} - \text{æŸå¤±} + \text{æ–°å¢}
$$

- æŸå¤±ï¼šæŒ‡å°†åŸæœ¬çš„ $s_i$ åˆ é™¤åï¼Œé€ æˆçš„ $\text{abc}$ å­åºåˆ—å‡å°‘é‡ã€‚
- æ–°å¢ï¼šæŒ‡å°† $s_i$ ä¿®æ”¹ä¸ºå¦ä¸€ä¸ªå­—ç¬¦åï¼Œå¸¦æ¥çš„æ–°å¢ $\text{abc}$ å­åºåˆ—æ•°é‡ã€‚

æšä¸¾å››ç§æƒ…å†µè¿›è¡Œåˆ†æï¼š

- $s_i = \text{a}$ï¼Œä¿®æ”¹ä¸º `b` æˆ– `c`ã€‚
- $s_i = \text{b}$ï¼Œä¿®æ”¹ä¸º `a` æˆ– `c`ã€‚
- $s_i = \text{c}$ï¼Œä¿®æ”¹ä¸º `a` æˆ– `b`ã€‚
- $s_i = \text{other}$ï¼Œä¿®æ”¹ä¸º `a` æˆ– `b` æˆ– `c`ã€‚

è¯´ç™½äº†å°±æ˜¯ç ”ç©¶æ¯ä¸ªä½ç½® `s[i]` åˆ†åˆ«å½“ `a, b, c` å¯¹å­åºåˆ— `abc` çš„è´¡çŒ®ã€‚

**a çš„è´¡çŒ®ï¼š**

å½“ `s[i]` ä¸º `a` æ—¶ï¼Œè´¡çŒ®çš„å­åºåˆ—æ•°é‡ä¸ºï¼š

$$
\sum_{j = i+1}^n [s_j = \texttt{'b'}] \cdot \left( \sum_{k = j}^n [s_k = \texttt{'c'}] \right)
$$

- å³åé¢æ¯ä¸ªå­—ç¬¦ `b` åœ¨ä¹˜ä»¥ `b` åé¢çš„ `c` çš„ä¸ªæ•°ã€‚

è®°åç¼€æ•°ç»„ $\text{sc[j]}$ è¡¨ç¤º $j$ åˆ° $n$ ä¸­å­—ç¬¦ $\text{c}$ çš„ä¸ªæ•°ï¼Œåˆ™æŸå¤±é‡å¯é‡å†™ä¸ºï¼š


$$
\sum_{j = i+1}^n [s_j = \texttt{'b'}] \cdot \texttt{sufc[j]}
$$

è¿›ä¸€æ­¥å®šä¹‰ä¸€ä¸ªè¾…åŠ©æ•°ç»„ï¼š

$$
\texttt{SC[i]} = \sum_{j = i}^n [s_j = \texttt{'b'}] \cdot \texttt{sc[j]}
$$

åˆ™ $a$ çš„è´¡çŒ®ä¸º `SC[i + 1]`ã€‚


**b çš„è´¡çŒ®ï¼š**

æ–°å¢ï¼š`sa[i - 1] * sc[i + 1]`ã€‚

- `sa[i - 1]` ä¸º $[1,i-1]$ ä¸­å­—ç¬¦ `a` çš„å‰ç¼€å’Œã€‚
- `sc[i + 1]` ä¸º $[i+1,n]$ ä¸­å­—ç¬¦ `c` çš„åç¼€å’Œã€‚

**c çš„è´¡çŒ®ï¼š**

$\texttt{SA[i]} = \sum\limits_{j=1}^{i-1} [s_j = \texttt{'b'}] \cdot \texttt{sa[j]}$


- å³å‰é¢æ¯ä¸ªå­—ç¬¦ `b` åœ¨ä¹˜ä»¥ `b` å‰é¢çš„ `a` çš„ä¸ªæ•°ã€‚


åˆ™ $c$ çš„è´¡çŒ®ä¸º `SA[i - 1]`ã€‚

å…·ä½“å®ç°å¯ä»¥å®šä¹‰ä¸€ä¸ª `f(int i, char c)` çš„è®¡ç®—è´¡çŒ®çš„å‡½æ•°ã€‚

æ³¨æ„ `long long`ã€‚


```cpp
#include <bits/stdc++.h>
#define int long long
using namespace std;
const int N = 5e5 + 5;
int n, sa[N], sc[N];
int SC[N], SA[N]; 
string s;
int f(int i, char c)
{
    if (c == 'a') return SC[i + 1];
    if (c == 'b') return sa[i - 1] * sc[i + 1];
    if (c == 'c') return SA[i - 1];
    return 0;
} 
signed main()
{
    cin >> n >> s;
    s = " " + s;
    for (int i = 1; i <= n; i++)
        sa[i] = sa[i - 1] + (s[i] == 'a');
    for (int i = n; i >= 1; i--)
        sc[i] = sc[i + 1] + (s[i] == 'c');
    for (int i = n; i >= 1; i--)
        if (s[i] == 'b')
            SC[i] = SC[i + 1] + sc[i];
        else
            SC[i] = SC[i + 1];
    for (int i = 1; i <= n; i++)
        if (s[i] == 'b')
            SA[i] = SA[i - 1] + sa[i];
        else
            SA[i] = SA[i - 1];
    int ans = 0;
    for (int i = 1; i <= n; i++)
        if (s[i] == 'b')
            ans += sa[i - 1] * sc[i + 1];
    int temp = ans;
    for (int i = 1; i <= n; i++)
    {
        ans = max(ans, temp - f(i, s[i]) + f(i, 'a'));
        ans = max(ans, temp - f(i, s[i]) + f(i, 'b'));
        ans = max(ans, temp - f(i, s[i]) + f(i, 'c'));
    }
    cout << ans;
    return 0;
}
```

___



### ä¾‹é¢˜ä¸‰ï¼šJOI 2021 Final

**é¢˜æ„ï¼š** ç»™å®šä¸€ä¸ªé•¿ä¸º $N,N \le 2 \times 10^5$ çš„åºåˆ— $A_i$ï¼Œä½ å¯ä»¥è¿›è¡Œè‹¥å¹²æ¬¡æ“ä½œï¼š

- é€‰å®šä¸€ä¸ªåŒºé—´ $[L,R]$ï¼Œè®©è¿™ä¸ªåŒºé—´é‡Œçš„æ•°åŠ  $1$ã€‚

æ±‚è‡³å°‘å¤šå°‘æ¬¡æ“ä½œä½¿å¾—åºåˆ— $A$ å˜ä¸ºä¸€ä¸ªå…ˆå‡åé™çš„åºåˆ—ã€‚


å¯¹åŒºé—´ $[l,r]$ åŠ  $1$ï¼Œå¯è½¬åŒ–ä¸ºåœ¨å·®åˆ†æ•°ç»„ä¸Šæ‰§è¡Œï¼š

$$
b_l \mathrel{+}= 1,\quad b_{r+1} \mathrel{-}= 1
$$

å…ˆå‡åé™çš„åºåˆ—å­˜åœ¨ä¸€ä¸ªè‡³é«˜ç‚¹ $i$ï¼Œå› æ­¤åšæ³•æ˜¯ï¼š

- é‡‡ç”¨é¢„å¤„ç†å·¦å³éƒ¨åˆ†ï¼Œå†æšä¸¾è‡³é«˜ç‚¹è¿›è¡Œåˆå¹¶ã€‚  

æ ¹æ®å·®åˆ†æ•°ç»„çš„æ€§è´¨å¯å¾—è‹¥æ»¡è¶³é€’å¢å°±æ˜¯ `b[i] > b[i - 1]`ï¼Œé€’å‡åˆ™ä¸º `b[i] < b[i - 1]`ã€‚

è‹¥ä»¥ $i$ å½“è‡³é«˜ç‚¹ï¼Œåˆ™ï¼š

- $b_2\ldots b_i >0$ï¼Œ$b_1$ æ— æ‰€è°“ã€‚
- $b_{i+1}\ldots b_n <0$

æ¢å¥è¯æ¥è¯´

- $b_2\ldots b_i$ ä¸­çš„éæ­£æ•°é€šè¿‡è‹¥å¹²æ¬¡åŠ  $1$ æ“ä½œä½¿å¾—æ¯ä¸€é¡¹å‡æ­£ã€‚

- $b_{i+1}\ldots b_n$ ä¸­çš„éè´Ÿæ•°é€šè¿‡è‹¥å¹²æ¬¡å‡ $1$ æ“ä½œä½¿å¾—æ¯ä¸€é¡¹å‡è´Ÿã€‚


å› æ­¤é¢„å¤„ç†ï¼š

- $pre_i$ï¼šä½¿å¾— $a_1,\dots,a_i$ ä¸¥æ ¼é€’å¢çš„æœ€å°‘æ“ä½œæ¬¡æ•°ï¼›
- $suf_i$ï¼šä½¿å¾— $a_i,\dots,a_n$ ä¸¥æ ¼é€’å‡çš„æœ€å°‘æ“ä½œæ¬¡æ•°ã€‚

åˆ™ç­”æ¡ˆä¸º


$$
ans = \min_{1\le i\le n} (ans,\max(pre_i, suf_{i+1}\bigr))
$$

> ä¸ºä½•ä¸æ˜¯ $pre[i]+suf[i+1]$ï¼Ÿ
> 
> å› ä¸ºå·®åˆ†æ“ä½œæ˜¯ç»‘å®šçš„ï¼Œé€‰æ‹©ä¸€ä¸ªä½ç½® $+1$ å¿…é¡»åŒæ—¶é€‰æ‹©ä¸€ä¸ªä½ç½® $-1$ã€‚
> 
> å› æ­¤æ“ä½œæ¬¡æ•°æ˜¯å‰åæ“ä½œæ¬¡æ•°çš„è¾ƒå¤§å€¼ã€‚


**è€ƒè™‘ä¸¥æ ¼é€’å¢**

ä¸ºä¿è¯åŒºé—´ $1\sim i$ ä¸¥æ ¼é€’å¢ï¼Œå¿…é¡»æœ‰å·®åˆ†æ•°ç»„ä¸­ $b_2,\dots,b_i > 0$ã€‚

- è‹¥æŸ $b_j \le 0$ï¼Œåˆ™è‡³å°‘éœ€è¦å¯¹å…¶åŠ åˆ° $1$ï¼ˆä¾‹å¦‚ $b_3 = -5$ åˆ™éœ€å¢åŠ  $6$ æ¬¡ï¼‰ã€‚

å¯é€šè¿‡å‰ç¼€å’Œé¢„å¤„ç†ï¼Œæ±‚å‡ºå‰ $i$ ä¸ªä½ç½®è°ƒæ•´åˆ°æ»¡è¶³è¦æ±‚çš„æœ€å°‘æ“ä½œæ¬¡æ•°ã€‚

```cpp
for (int i = 2; i <= n; i++) // ç¬¬ä¸€é¡¹æ— æ‰€è°“ä»ç¬¬äºŒé¡¹å¼€å§‹
{
    b[i] = a[i] - a[i - 1];
    if (b[i] <= 0)
        pre[i] = pre[i - 1] + abs(b[i]) + 1;
    else
        pre[i] = pre[i - 1];
}
```

**é¢„å¤„ç†ä¸¥æ ¼é€’å‡**

åŒç†ï¼Œä¸ºä½¿åŒºé—´ $i\sim n$ ä¸¥æ ¼é€’å‡ï¼Œè¦æ±‚ç›¸åº”ä½ç½®è°ƒä¸ºæ°å¥½ $-1$ï¼ˆå³ä»éè´Ÿå€¼é™ä¸º $-1$ï¼‰ã€‚

- åˆ©ç”¨åç¼€å’Œé¢„å¤„ç†ï¼Œå¯ä»¥æ±‚å‡ºååŠéƒ¨åˆ†çš„æœ€å°‘æ“ä½œæ¬¡æ•°ã€‚


```cpp
for (int i = n; i >= 2; i++) 
{
    if (b[i] >= 0)
        suf[i] = suf[i + 1] + b[i] + 1;
    else
        suf[i] = suf[i + 1];
}
```


**ç­”æ¡ˆ**

```cpp
for (int i = 1; i <= n; i++) // æšä¸¾æœ€é«˜ç‚¹
{
    ans = min(ans, max(pre[i], suf[i + 1]));
}
```


___


### ä¾‹é¢˜å››ï¼šç«çƒ§èµ¤å£


**é¢˜æ„ï¼š** ç»™å®š $n$ ä¸ªåŒºé—´ $[l,r)$ï¼Œæ±‚åŒºé—´å¹¶é›†çš„æ€»é•¿åº¦ã€‚

æ•°æ®èŒƒå›´ï¼š$n\leq 2\cdot 10^4$ï¼Œ$-2^{31}\leq l<r< 2^{31}$ã€‚



**ğŸ” è§£é¢˜æ€è·¯**

ç”±äºåŒºé—´çš„å€¼åŸŸéå¸¸å¤§ï¼ˆ$[-2^{31}, 2^{31})$ï¼‰ï¼Œæˆ‘ä»¬æ— æ³•ç›´æ¥å»ºç«‹æ•°ç»„æ¥è®°å½•æ¯ä¸ªä½ç½®çš„è¦†ç›–æƒ…å†µï¼Œå› æ­¤éœ€è¦ä½¿ç”¨**ç¦»æ•£åŒ– + å·®åˆ†æ•°ç»„**çš„æ–¹å¼æ¥é«˜æ•ˆæ±‚è§£åŒºé—´å¹¶çš„é•¿åº¦ã€‚



**âœ… æ­¥éª¤ä¸€ï¼šç¦»æ•£åŒ–**

é¦–å…ˆå°†æ‰€æœ‰åŒºé—´çš„å·¦å³ç«¯ç‚¹æå–å‡ºæ¥ï¼Œè¿›è¡Œ**å»é‡**å’Œ**æ’åº**ï¼Œå»ºç«‹ä¸€ä¸ªå‹ç¼©åæ ‡ç³»ã€‚

ã€ŒåŸå§‹å€¼åŸŸ â†’ ç¦»æ•£åŒ–åçš„ä¸‹æ ‡ã€

ç¦»æ•£åŒ–çš„ä½œç”¨æ˜¯å°†ç¨€ç–çš„ç«¯ç‚¹æ˜ å°„ä¸ºè¿ç»­çš„æ•°ç»„ä¸‹æ ‡ï¼Œæ–¹ä¾¿ä½¿ç”¨æ•°ç»„å¤„ç†è¦†ç›–æƒ…å†µã€‚


**âœ… æ­¥éª¤äºŒï¼šå·®åˆ†æ•°ç»„**

å·®åˆ†æ•°ç»„çš„æ ¸å¿ƒæ€æƒ³æ˜¯ï¼š

- å¯¹äºåŒºé—´ `[l, r)`ï¼š
    - ç”±äºæ˜¯å·¦é—­å³å¼€ï¼Œå› æ­¤å®é™…æ˜¯åŒºé—´ $[l,r-1]$ã€‚

    - åœ¨ `l`å¯¹åº”çš„ç¦»æ•£ä¸‹æ ‡ä½ç½® `+1`
    - åœ¨ `r`å¯¹åº”çš„ç¦»æ•£ä¸‹æ ‡ä½ç½® `-1`

ç„¶åå¯¹å·®åˆ†æ•°ç»„åšå‰ç¼€å’Œå³å¯å¾—åˆ°æ¯ä¸€æ®µåŒºé—´çš„**è¢«è¦†ç›–æ¬¡æ•°**ã€‚



**âœ… æ­¥éª¤ä¸‰ï¼šè®¡ç®—ç»“æœ**

å¯¹äºå·®åˆ†æ•°ç»„æ±‚å‡ºçš„å‰ç¼€å’Œï¼Œå¦‚æœæŸä¸€æ®µåŒºé—´è¢«è¦†ç›–æ¬¡æ•°å¤§äº `0`ï¼Œè¯´æ˜è¯¥æ®µå±äºå¹¶é›†ï¼Œç»Ÿè®¡å…¶å®é™…é•¿åº¦ã€‚

æ³¨æ„ï¼šç¦»æ•£åŒ–åç›¸é‚»çš„ç¦»æ•£ç‚¹ `lsh[i]` å’Œ `lsh[i+1]`å¯¹åº”çš„åŸå§‹å€¼ä¸ä¸€å®šæ˜¯è¿ç»­çš„ï¼Œæ‰€ä»¥éœ€è®¡ç®—å®é™…é•¿åº¦ï¼š

```
lsh[i+1] - lsh[i]
```


**âœ… æ—¶é—´å¤æ‚åº¦åˆ†æ**

* ç¦»æ•£åŒ–æ’åºï¼š$O(n \log n)$
* åŒºé—´å·®åˆ†æ ‡è®°ï¼š$O(n)$
* éå†ç»Ÿè®¡ç»“æœï¼š$O(n)$

**æ€»å¤æ‚åº¦ï¼š\$O(n \log n)\$**




```cpp
#include <bits/stdc++.h>

using namespace std;
const int N = 2e4 + 5;
int n, l[N], r[N], diff[N], lsh[N * 2], ans;
int main()
{
    ios::sync_with_stdio(false);
    cin.tie(0);
    cin >> n;
    for (int i = 1; i <= n; i++)
    {
        cin >> l[i] >> r[i];
        lsh[i] = l[i], lsh[i + n] = r[i];
    }
    sort(lsh + 1, lsh + n * 2 + 1);
    int m = unique(lsh + 1, lsh + n * 2+ 1) - (lsh + 1);
    for (int i = 1; i <= n; i++)
    {
        l[i] = lower_bound(lsh + 1, lsh + m + 1, l[i]) - lsh;
        r[i] = lower_bound(lsh + 1, lsh + m + 1, r[i]) - lsh;
        diff[l[i]]++;
        diff[r[i]]--;
    }
    for (int i = 1; i < m; i++)
    {
        diff[i] += diff[i - 1];
        if (diff[i])
        {
            ans += lsh[i + 1] - lsh[i]; 
        }
    }
    cout << ans;
    return 0;
}
```


___



### ä¾‹é¢˜äº”ï¼š[NOIP2022] ç§èŠ±


**é¢˜æ„ï¼š** ç»™å®š $n \times m$ çš„ç½‘æ ¼å›¾ï¼Œæ¯ä¸ªæ ¼å­å¯èƒ½æ˜¯åœŸå‘ï¼ˆ1ï¼‰æˆ–å¯ç§èŠ±ï¼ˆ0ï¼‰ã€‚å®šä¹‰ä¸¤ç§å›¾æ¡ˆï¼š

- `C` å½¢: å­˜åœ¨ $x_1,x_2,y_0,y_1,y_2$ æ»¡è¶³ï¼š
    - ç¬¬ $x_1$ è¡Œ $[y_0,y_1]$ å…¨ $0$
    - ç¬¬ $x_2$ è¡Œ $[y_0,y_2]$ å…¨ $0$
    - ç¬¬ $y_0$ åˆ— $[x_1,x_2]$ å…¨ $0$
    - $x_1+1<x_2$, $y_0<y_1,y_2$
- `F` å½¢ï¼šåœ¨Cå½¢åŸºç¡€ä¸Šå¢åŠ ï¼š
    - å­˜åœ¨ $x_3 > x_2$ ä½¿ç¬¬ $y_0$ åˆ— $[x_1,x_3]$ å…¨ $0$
- æ•°æ®èŒƒå›´ï¼š$1\leq n,m\leq 10^3$ã€‚


**æš´åŠ›æ€è·¯ï¼š**

å…ˆè§£å†³ `C` å½¢ï¼š

- $x_1\in [1,n]$ï¼Œ$x_2\in [x_1+2,n]$ï¼Œ$y_0\in [1,m]$
- é¢„å¤„ç† $r[i][j]$ è¡¨ç¤º $(i,j)$ å‘å³è¿ç»­ $0$ æ•°é‡ï¼ˆå«è‡ªèº«ï¼‰
- åˆ¤æ–­ $y_0$ åˆ— $[x_1, x_2]$ è¡Œæ˜¯å¦å…¨ä¸º $0$
- ç­”æ¡ˆå¢åŠ ï¼š

$$
\texttt{C å½¢} = (r[x_1][y_0] - 1) \cdot (r[x_2][y_0] - 1)
$$

> åˆ¤æ–­æ˜¯å¦å…¨ä¸º $0$
> 
> é¢„å¤„ç† $d[i][j]$ è¡¨ç¤º $(i,j)$ å‘ä¸‹è¿ç»­ $0$ æ•°é‡ï¼ˆå«è‡ªèº«ï¼‰
> 
> æ¡ä»¶ï¼š$d[x_1][y_0] - d[x_2 + 1][y_0] = x_2 - x_1 + 1$

å†è§£å†³ `F` å½¢ï¼š

åŸºäº C å½¢çš„æ‰©å±•ï¼š

- åœ¨ C å½¢çš„åŸºç¡€ä¸Šï¼Œè‹¥ç¬¬ $y_0$ åˆ—ä» $x_2$ å‘ä¸‹è¿˜èƒ½å»¶ä¼¸ $0$ï¼Œåˆ™æ„æˆ F å½¢
- ç­”æ¡ˆè´¡çŒ®ä¹˜ä»¥ï¼š$d[x_2][y_0] - 1$

$$
\texttt{F å½¢} = (r[x_1][y_0] - 1) \cdot (r[x_2][y_0] - 1) \cdot (d[x_2][y_0] - 1)
$$


```cpp
void solve()
{
    cin >> n >> m >> C >> F;
    for (int i = 1; i <= n; i++) 
        for (int j = 1; j <= m; j++)
            cin >> a[i][j];
    vector<vector<int>> r(n + 1, vector<int>(m + 2, 0));
    for (int i = 1; i <= n; i++)
        for (int j = m; j >= 1; j--)
            r[i][j] = (a[i][j] == 0 ? r[i][j + 1] + 1 : 0);
    vector<vector<int>> d(n + 2, vector<int>(m + 1, 0));
    for (int i = n; i >= 1; i--)
        for (int j = 1; j <= m; j++)
            d[i][j] = (a[i][j] == 0 ? d[i + 1][j] + 1 : 0);
    ll resc = 0, resf = 0;
    for (int x1 = 1; x1 <= n; x1++)
    {
        for (int x2 = x1 + 2; x2 <= n; x2++)
        {
            for (int y0 = 1; y0 <= m; y0++)
            {
                if (a[x1][y0] == '1' || a[x2][y0] == '1') continue;
                if (d[x1][y0] - d[x2 + 1][y0] != x2 - x1 + 1) continue;
                resc = (resc + (r[x2][y0] - 1) * (r[x1][y0] - 1)) % mod;
                resf = (resf + (r[x2][y0] - 1) * (r[x1][y0] - 1) % mod * (d[x2][y0] - 1)) % mod;
            }
        }
    }
    cout << resc * C % mod << " " << resf * F % mod << "\n";
}
```


**ä» $O(n^2m)$ åˆ° $O(nm)$ çš„ä¼˜åŒ–**


åŸå¼ï¼š


$$
ans = \sum_{x_1=1}^n \sum_{x_2=x_1+2}^n \sum_{y=1}^m (r[x_1][y]-1)(r[x_2][y]-1)
$$


å˜å½¢ï¼š

$$
ans = \sum_{x_2=3}^n \sum_{y=1}^m (r[x_2][y]-1) \cdot \underbrace{\left(\sum_{x_1=1}^{x_2-2} (r[x_1][y] - 1)\right)}_{sum[x_2][y]}
$$


å®šä¹‰å‰ç¼€å’Œè½¬ç§»ï¼š

$$
sum[x][y] = \begin{cases}
   sum[x-1][y] + (r[x-2][y] - 1), & \text{è‹¥ $(x-2,y)\sim(x,y)$ è¿ç»­ä¸º $0$} \\
   0, & \text{å¦åˆ™}
\end{cases}
$$

**æ³¨æ„ï¼š** è¿ç»­æ€§ä»éœ€ç”¨ $d[x-2][y] \geq 3$ åˆ¤æ–­ã€‚


```cpp
void solve()
{
    vector<vector<int>> r(n + 1, vector<int>(m + 2, 0));
    for (int i = 1; i <= n; i++)
        for (int j = m; j >= 1; j--)
            r[i][j] = (a[i][j] == 0 ? r[i][j + 1] + 1 : 0);
    vector<vector<int>> d(n + 2, vector<int>(m + 1, 0));
    for (int i = n; i >= 1; i--)
        for (int j = 1; j <= m; j++)
            d[i][j] = (a[i][j] == 0 ? d[i + 1][j] + 1 : 0);
    Z resc = 0, resf = 0;
    vector<vector<Z>> sum(n + 1, vector<Z>(m + 1, 0));
    for (int x2 = 3; x2 <= n; x2++)
    {
        for (int y0 = 1; y0 <= m; y0++)
        {
            if (d[x2 - 2][y0] - d[x2 + 1][y0] == 3)
                sum[x2][y0] = sum[x2 - 1][y0] + (r[x2 - 2][y0] - 1);
            else   
                sum[x2][y0] = 0;
            if (a[x2][y0] == 0)
            {
                resc += (r[x2][y0] - 1) * sum[x2][y0];
                resf += (r[x2][y0] - 1) * (d[x2][y0] - 1) * sum[x2][y0];
            }
        }
    }
    cout << resc * c << " " << resf * f << "\n";
}
```




